{% extends "base.html" %}
{% from "_formhelpers.html" import render_field %} {# Assuming you have a macro for rendering fields #}

{% block content %}
    <div class="container-fluid mt-4" style="max-width: 1500px;">
        <div class="row">
            {# Left Sidebar - Friend Suggestions #}
            <div class="col-md-3">
                <div class="card shadow-sm mb-4" style="position: static; top: 20px;">
                    <div class="card-header" style="background-color: #09619f; color: white;">
                        <h5 class="mb-0" style="color: white;"><i class="fas fa-user-friends mr-2"></i>People You May Know</h5>
                    </div>
                    <div class="card-body p-0" id="friend-recommendations">
                        {# Recommendations will be loaded here dynamically #}
                    </div>
                </div>
            </div>

            {# Main Feed Content - Original Width #}
            <div class="col-md-6">
                {# Create Post Form #}
                <div class="card create-post-area mb-4 shadow-sm">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-start">
                            <img src="



                                    {{ url_for('static', filename=current_user.profile_pic) if current_user.profile_pic.startswith('images/') else url_for('main.uploaded_profile_pic', filename=current_user.profile_pic.split('/')[-1]) if current_user.profile_pic else url_for('static', filename='images/default_profile.jpg') }}"
                                 alt="{{ current_user.username }}'s profile picture"
                                 class="rounded-circle mr-3" style="width: 45px; height: 45px; object-fit: cover;">

                            <form method="POST" action="{{ url_for('main.dashboard') }}" class="w-100"
                                  enctype="multipart/form-data">
                                {{ post_form.hidden_tag() }} {# Includes CSRF #}
                                <div class="form-group mb-2">
                                    {{ post_form.content(class="form-control create-post-textarea", rows="3", placeholder="What's on your mind, " + current_user.username + "?") }}
                                    {% if post_form.content.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in post_form.content.errors %}
                                                <span>{{ error }}</span>{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                {# WTForms will render <input type="file" id="media_upload" name="media_upload" ... > #}
                                {# We use a div to wrap it if we want to hide the whole field including its label if any #}
                                <div class="d-none"> {# Hide the default rendering of the FileField #}
                                    {{ post_form.media_upload(id="actualMediaUploadField") }}
                                    {# Assign a specific ID for JS #}
                                </div>
                                {% if post_form.media_upload.errors %} {# Show errors for the file field #}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in post_form.media_upload.errors %}
                                            {{ error }}<br>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div id="selectedFileName" class="text-muted small mb-2"></div>
                                {# To show selected file name #}


                                {# --- Action Buttons Row --- #}
                                <div class="d-flex justify-content-between align-items-center">
                                    {# Left side: Add Media Button - THIS TRIGGERS THE WTFORMS INPUT #}
                                    <div>
                                        <button type="button" class="btn btn-light btn-sm"
                                                onclick="document.getElementById('actualMediaUploadField').click();"
                                                {# Target WTForms input ID #}
                                                title="Add photo/video">
                                            <i class="fas fa-photo-video text-success"></i>
                                            <span class="d-none d-md-inline ml-1">Photo/Video</span>
                                        </button>
                                    </div>

                                    {# Right side: Visibility and Post Button #}
                                    <div class="d-flex align-items-center">
                                        <div class="form-group mb-0 mr-2">
                                            {{ post_form.visibility(class="form-control custom-select form-control-sm") }}
                                            {% if post_form.visibility.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {% for error in post_form.visibility.errors %}
                                                        <span>{{ error }}</span>{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        {{ post_form.submit(class="btn btn-primary btn-sm", value="Hatch") }}
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {# --- End Create Post Form --- #}

                {% if items %}
                    {% for item_type, item in items %}
                        <div class="card post-card mb-4 shadow-sm" 
                             onclick="window.location.href='{{ url_for('main.view_post', post_id=(item.id if item_type == 'post' else item.original_post.id)) }}'" 
                             style="cursor: pointer;">
                            {% set target_post = item if item_type == 'post' else item.original_post %}
                            <div class="card-header bg-white border-0 py-3">
                                <div class="d-flex align-items-center">
                                    {% if item_type == 'share' %}
                                        {# Show share information #}
                                        <a href="{{ url_for('profile.view_profile', username=item.author.username) }}">
                                            <img src="{{ url_for('static', filename=item.author.profile_pic) if item.author.profile_pic.startswith('images/') else url_for('main.uploaded_profile_pic', filename=item.author.profile_pic.split('/')[-1]) if item.author.profile_pic else url_for('static', filename='images/default_profile.jpg') }}"
                                                 alt="{{ item.author.username }}'s profile picture"
                                                 class="rounded-circle mr-3"
                                                 style="width: 45px; height: 45px; object-fit: cover;">
                                        </a>
                                        <div>
                                            <a href="{{ url_for('profile.view_profile', username=item.author.username) }}"
                                               class="font-weight-bold text-dark text-decoration-none">
                                                {{ item.author.first_name }} {{ item.author.last_name }}
                                                <small class="text-muted d-block">@{{ item.author.username }}</small>
                                            </a>
                                            <small class="text-muted">
                                                Echoed a hatch Â· {{ item.timestamp.strftime('%b %d, %Y %I:%M %p') }}
                                            </small>
                                        </div>
                                    {% else %}
                                        {# Regular post header #}
                                        <a href="{{ url_for('profile.view_profile', username=item.author.username) }}">
                                            <img src="{{ url_for('static', filename=item.author.profile_pic) if item.author.profile_pic.startswith('images/') else url_for('main.uploaded_profile_pic', filename=item.author.profile_pic.split('/')[-1]) if item.author.profile_pic else url_for('static', filename='images/default_profile.jpg') }}"
                                                 alt="{{ item.author.username }}'s profile picture"
                                                 class="rounded-circle mr-3"
                                                 style="width: 45px; height: 45px; object-fit: cover;">
                                        </a>
                                        <div>
                                            <a href="{{ url_for('profile.view_profile', username=item.author.username) }}"
                                               class="font-weight-bold text-dark text-decoration-none">
                                                {{ item.author.first_name }} {{ item.author.last_name }}
                                                <small class="text-muted d-block">@{{ item.author.username }}</small>
                                            </a>
                                            <small class="text-muted">
                                                Hatched {{ item.timestamp.strftime('%b %d, %Y %I:%M %p') }}
                                                <span class="mx-1">Â·</span>
                                                <i class="fas fa-globe-americas" title="{{ item.visibility.value.capitalize() }}"></i>
                                            </small>
                                        </div>
                                    {% endif %}

                                    {% if (item_type == 'post' and item.author == current_user) or (item_type == 'share' and item.author == current_user) %}
                                        <div class="dropdown ml-auto">
                                            <button class="btn btn-link text-muted p-0" type="button"
                                                    id="postOptions{{ item.id }}" data-toggle="dropdown"
                                                    aria-haspopup="true" aria-expanded="false">
                                                <i class="fas fa-ellipsis-h"></i>
                                            </button>
                                            <div class="dropdown-menu dropdown-menu-right"
                                                 aria-labelledby="postOptions{{ item.id }}">
                                                {% if item_type == 'post' %}
                                                    <a class="dropdown-item"
                                                       href="{{ url_for('main.edit_post', post_id=item.id) }}">
                                                        <i class="fas fa-pen"></i> Edit
                                                    </a>
                                                    <button 
                                                            class="dropdown-item text-danger"
                                                            type="button"
                                                            onclick="confirmDelete('{{ url_for('main.delete_post', post_id=item.id) }}')">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                {% else %}
                                                    {# Add share deletion if implemented #}
                                                    <button class="dropdown-item text-danger">
                                                        <i class="fas fa-trash"></i> Remove Share
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="card-body">
                                {% if item_type == 'share' %}
                                    {% if item.content %}
                                        <p class="card-text mb-3" style="white-space: pre-wrap;">{{ item.content }}</p>
                                    {% endif %}
                                    <div class="shared-post-container border rounded">
                                        <div class="card-header bg-white border-0 py-2">
                                            <div class="d-flex align-items-center">
                                                <a href="{{ url_for('profile.view_profile', username=item.original_post.author.username) }}">
                                                    <img src="{{ url_for('static', filename=item.original_post.author.profile_pic) if item.original_post.author.profile_pic.startswith('images/') else url_for('main.uploaded_profile_pic', filename=item.original_post.author.profile_pic.split('/')[-1]) if item.original_post.author.profile_pic else url_for('static', filename='images/default_profile.jpg') }}"
                                                         alt="{{ item.original_post.author.username }}'s profile picture"
                                                         class="rounded-circle mr-2"
                                                         style="width: 35px; height: 35px; object-fit: cover;">
                                                </a>
                                                <div>
                                                    <a href="{{ url_for('profile.view_profile', username=item.original_post.author.username) }}"
                                                       class="font-weight-bold text-dark text-decoration-none">
                                                        {{ item.original_post.author.first_name }} {{ item.original_post.author.last_name }}
                                                        <small class="text-muted d-block">@{{ item.original_post.author.username }}</small>
                                                    </a>
                                                    <small class="text-muted">
                                                        {{ item.original_post.timestamp.strftime('%b %d, %Y %I:%M %p') }}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body py-2">
                                            <p class="card-text" style="white-space: pre-wrap;">{{ item.original_post.content }}</p>
                                            {% if item.original_post.media %}
                                                {% set media_url = "" %}
                                                {% if item.original_post.media.startswith('post_media/') %}
                                                    {% set media_url = url_for('main.uploaded_post_media', filename=item.original_post.media.split('/')[-1]) %}
                                                {% elif item.original_post.media.startswith('images/') %}
                                                    {% set media_url = url_for('static', filename=item.original_post.media) %}
                                                {% else %}
                                                    {% if item.original_post.media %}
                                                        {% set media_url = url_for('static', filename='post_media/' + item.original_post.media) %}
                                                    {% endif %}
                                                {% endif %}

                                                {% if media_url %}
                                                    {% set filename_lower = item.original_post.media.lower() %}
                                                    {% if filename_lower.endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
                                                        <img src="{{ media_url }}" class="img-fluid rounded"
                                                             alt="Post media"
                                                             style="max-height: 350px; object-fit: contain; display: block; margin-left: auto; margin-right: auto;">
                                                    {% elif filename_lower.endswith(('.mp4', '.mov', '.avi', '.mkv', '.webm')) %}
                                                        <video controls width="100%" class="rounded"
                                                               style="max-height: 350px; background-color: #000;">
                                                            <source src="{{ media_url }}"
                                                                    type="video/{{ filename_lower.split('.')[-1] }}">
                                                            Your browser does not support the video tag.
                                                        </video>
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                {% else %}
                                    <p class="card-text" style="white-space: pre-wrap;">{{ item.content }}</p>
                                {% endif %}

                                {% set post = item if item_type == 'post' else item.original_post %}
                                {% if post.media and not item_type == 'share' %}
                                    {% set media_url = "" %}
                                    {% if post.media.startswith('post_media/') %}
                                        {% set media_url = url_for('main.uploaded_post_media', filename=post.media.split('/')[-1]) %}
                                    {% elif post.media.startswith('images/') %}
                                        {% set media_url = url_for('static', filename=post.media) %}
                                    {% else %}
                                        {% if post.media %}
                                            {% set media_url = url_for('static', filename='post_media/' + post.media) %}
                                        {% endif %}
                                    {% endif %}

                                    {% if media_url %}
                                        {% set filename_lower = post.media.lower() %}
                                        {% if filename_lower.endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
                                            <img src="{{ media_url }}" class="img-fluid rounded mt-2 mb-3"
                                                 alt="Post media"
                                                 style="max-height: 500px; object-fit: contain; display: block; margin-left: auto; margin-right: auto;">
                                        {% elif filename_lower.endswith(('.mp4', '.mov', '.avi', '.mkv', '.webm')) %}
                                            <video controls width="100%" class="mt-2 mb-3 rounded"
                                                   style="max-height: 450px; background-color: #000;">
                                                <source src="{{ media_url }}"
                                                        type="video/{{ filename_lower.split('.')[-1] }}">
                                                Your browser does not support the video tag.
                                            </video>
                                        {% else %}
                                            <p class="mt-2 mb-3">
                                                <small>
                                                    <a href="{{ media_url }}" target="_blank">
                                                        View Media Attachment: {{ post.media.split('/')[-1] }}
                                                    </a>
                                                </small>
                                            </p>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </div>

                            <div class="card-footer bg-white d-flex justify-content-around py-2 border-top">
                                {% if item_type == 'share' %}
                                    <form method="POST" action="{{ url_for('main.like_share', share_id=item.id) }}"
                                          class="d-inline-block like-form">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-link text-muted p-1">
                                            {% if item.is_liked_by(current_user) %}
                                                <i class="fas fa-heart text-danger"></i>
                                                <span class="text-danger">Seeded</span>
                                            {% else %}
                                                <i class="far fa-heart"></i> Seed
                                            {% endif %}
                                            <span class="badge badge-light ml-1">{{ item.like_count() }}</span>
                                        </button>
                                    </form>
                                    <button class="btn btn-link text-muted p-1" data-toggle="collapse"
                                            data-target="#comments-share-{{ item.id }}" aria-expanded="false"
                                            aria-controls="comments-share-{{ item.id }}">
                                        <i class="far fa-comment"></i> Peep
                                        <span class="badge badge-light ml-1">{{ item.comment_count() }}</span>
                                    </button>
                                {% else %}
                                    <form method="POST" action="{{ url_for('main.like_post', post_id=item.id) }}"
                                          class="d-inline-block like-form">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-link text-muted p-1">
                                            {% if item.is_liked_by(current_user) %}
                                                <i class="fas fa-heart text-danger"></i>
                                                <span class="text-danger">Seeded</span>
                                            {% else %}
                                                <i class="far fa-heart"></i> Seed
                                            {% endif %}
                                            <span class="badge badge-light ml-1">{{ item.like_count() }}</span>
                                        </button>
                                    </form>
                                    <button class="btn btn-link text-muted p-1" data-toggle="collapse"
                                            data-target="#comments-{{ item.id }}" aria-expanded="false"
                                            aria-controls="comments-{{ item.id }}">
                                        <i class="far fa-comment"></i> Peep
                                        <span class="badge badge-light ml-1">{{ item.comment_count() }}</span>
                                    </button>
                                {% endif %}
                                <button class="btn btn-link text-muted p-1"
                                        type="button"
                                        onclick="sharePost({{ item.id if item_type == 'post' else item.original_post.id }})">
                                    <i class="fas fa-share"></i> Echo
                                </button>
                            </div>

                            {# Comments Section #}
                            {% if item_type == 'share' %}
                                <div class="collapse" id="comments-share-{{ item.id }}">
                                    <div class="card-footer bg-light border-top-0">
                                        <div class="comments-list mb-3">
                                            {% if item.comments is defined %}
                                                {% for comment in item.comments|sort(attribute='timestamp') %}
                                                    <div class="comment d-flex mb-2">
                                                        <img src="{{ url_for('static', filename=comment.author.profile_pic) if comment.author.profile_pic.startswith('images/') else url_for('main.uploaded_profile_pic', filename=comment.author.profile_pic.split('/')[-1]) if comment.author.profile_pic else url_for('static', filename='images/default_profile.jpg') }}"
                                                             alt="{{ comment.author.username }}" class="rounded-circle mr-2"
                                                             style="width: 30px; height: 30px; object-fit: cover;">
                                                        <div class="bg-white p-2 rounded shadow-sm flex-grow-1">
                                                            <strong>{{ comment.author.username }}</strong>
                                                            <small class="text-muted float-right">{{ comment.timestamp.strftime('%b %d, %I:%M %p') }}</small>
                                                            <p class="mb-0">{{ comment.content }}</p>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <p class="text-muted small">No comments yet.</p>
                                                {% endfor %}
                                            {% else %}
                                                <p class="text-muted small">No comments yet.</p>
                                            {% endif %}
                                        </div>
                                        {% if current_user.is_authenticated %}
                                            <form method="POST"
                                                  action="{{ url_for('main.add_comment_to_share', share_id=item.id) }}"
                                                  class="add-comment-form">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <div class="input-group">
                                                    <input type="text" name="comment_text"
                                                           class="form-control form-control-sm"
                                                           placeholder="Write a peep..." required>
                                                    <div class="input-group-append">
                                                        <button type="submit" class="btn btn-outline-primary btn-sm">Peep</button>
                                                    </div>
                                                </div>
                                            </form>
                                        {% endif %}
                                    </div>
                                </div>
                            {% else %}
                                <div class="collapse" id="comments-{{ item.id }}">
                                    <div class="card-footer bg-light border-top-0">
                                        <div class="comments-list mb-3">
                                            {% for comment in item.comments|sort(attribute='timestamp') %}
                                                <div class="comment d-flex mb-2">
                                                    <img src="{{ url_for('static', filename=comment.author.profile_pic) if comment.author.profile_pic.startswith('images/') else url_for('main.uploaded_profile_pic', filename=comment.author.profile_pic.split('/')[-1]) if comment.author.profile_pic else url_for('static', filename='images/default_profile.jpg') }}"
                                                         alt="{{ comment.author.username }}" class="rounded-circle mr-2"
                                                         style="width: 30px; height: 30px; object-fit: cover;">
                                                    <div class="bg-white p-2 rounded shadow-sm flex-grow-1">
                                                        <strong>{{ comment.author.username }}</strong>
                                                        <small class="text-muted float-right">{{ comment.timestamp.strftime('%b %d, %I:%M %p') }}</small>
                                                        <p class="mb-0">{{ comment.content }}</p>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <p class="text-muted small">No comments yet.</p>
                                            {% endfor %}
                                        </div>
                                        {% if current_user.is_authenticated %}
                                            <form method="POST"
                                                  action="{{ url_for('main.add_comment', post_id=item.id) }}"
                                                  class="add-comment-form">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <div class="input-group">
                                                    <input type="text" name="comment_text"
                                                           class="form-control form-control-sm"
                                                           placeholder="Write a peep..." required>
                                                    <div class="input-group-append">
                                                        <button type="submit" class="btn btn-outline-primary btn-sm">Peep</button>
                                                    </div>
                                                </div>
                                            </form>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}

                    {# Pagination #}
                    {% if pagination %}
                        <nav aria-label="Page navigation" class="mt-4">
                            <ul class="pagination justify-content-center">
                                {% if pagination.has_prev %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('main.dashboard', page=pagination.prev_num) }}">Previous</a>
                                    </li>
                                {% endif %}
                                
                                {% for page_num in pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                                    {% if page_num %}
                                        <li class="page-item {{ 'active' if page_num == pagination.page else '' }}">
                                            <a class="page-link" href="{{ url_for('main.dashboard', page=page_num) }}">{{ page_num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled"><span class="page-link">...</span></li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if pagination.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('main.dashboard', page=pagination.next_num) }}">Next</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-stream fa-3x text-muted mb-3"></i>
                        <p class="lead text-muted">No hatches to display.</p>
                        <p>Why not create the first one?</p>
                    </div>
                {% endif %}
            </div>

            {# Right Sidebar - Popular Posts #}
            <div class="col-md-3">
                <div class="card shadow-sm mb-4" style="position: static; top: 20px;">
                    <div class="card-header" style="background-color: #f0a200; color: white;">
                        <h5 class="mb-0"><i class="fas fa-fire mr-2"></i>Popular Posts</h5>
                    </div>
                    <div class="card-body p-0">
                        {% set popular_posts = current_user.get_popular_posts(limit=5) %}
                        {% if popular_posts %}
                            {% for post in popular_posts %}
                                <div class="p-3 {% if not loop.last %}border-bottom{% endif %}" style="position: relative;">
                                    <a href="{{ url_for('main.view_post', post_id=post.id) }}" class="text-decoration-none text-dark" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1;"></a>
                                    <div class="d-flex align-items-center mb-2" style="position: relative; z-index: 2;">
                                        <img src="{{ url_for('static', filename=post.author.profile_pic) if post.author.profile_pic.startswith('images/') else url_for('main.uploaded_profile_pic', filename=post.author.profile_pic.split('/')[-1]) if post.author.profile_pic else url_for('static', filename='images/default_profile.jpg') }}"
                                             class="rounded-circle mr-2"
                                             style="width: 35px; height: 35px; object-fit: cover;"
                                             alt="{{ post.author.username }}'s profile picture">
                                        <div>
                                            <h6 class="mb-0">{{ post.author.first_name }} {{ post.author.last_name }}</h6>
                                            <small class="text-muted">@{{ post.author.username }}</small>
                                        </div>
                                    </div>
                                    <p class="card-text small mb-2" style="white-space: pre-wrap;">{{ post.content[:100] }}{% if post.content|length > 100 %}...{% endif %}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">{{ post.timestamp.strftime('%b %d') }}</small>
                                        <div>
                                            <span class="me-2">
                                                <i class="fas fa-heart"></i> {{ post.like_count() }}
                                            </span>
                                            <span>
                                                <i class="fas fa-comment"></i> {{ post.comment_count() }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted text-center p-3">No popular posts available at the moment.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Share Modal #}
    <div class="modal fade" id="shareModal" tabindex="-1" role="dialog" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareModalLabel">Echo Hatch</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="shareForm" method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="form-group">
                            <label for="shareContent">Add a peep (optional)</label>
                            <textarea class="form-control" id="shareContent" name="share_content" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Echo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function confirmDelete(deleteUrl) {
            if (confirm("Are you sure you want to delete this post?")) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = deleteUrl;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = '{{ csrf_token() }}';
                form.appendChild(csrfInput);
                document.body.appendChild(form);
                form.submit();
            }
        }

        function sharePost(postId) {
            const modal = $('#shareModal');
            const form = $('#shareForm');
            form.attr('action', `/post/${postId}/share`);
            modal.modal('show');
        }

        document.getElementById('actualMediaUploadField').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name;
            if (fileName) {
                document.getElementById('selectedFileName').textContent = `Selected file: ${fileName}`;
            } else {
                document.getElementById('selectedFileName').textContent = '';
            }
        });

        // Add this new function for handling post card clicks
        document.addEventListener('DOMContentLoaded', function() {
            const postCards = document.querySelectorAll('.post-card');
            postCards.forEach(card => {
                card.addEventListener('click', function(e) {
                    // Don't navigate if clicking on buttons, forms, or links
                    if (e.target.closest('.card-footer') || 
                        e.target.closest('button') || 
                        e.target.closest('a') || 
                        e.target.closest('form')) {
                        return;
                    }
                    
                    const postUrl = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                    window.location.href = postUrl;
                });
            });
        });

        function loadFriendRecommendations() {
            fetch('/api/friend-recommendations')
                .then(response => response.json())
                .then(recommendations => {
                    const container = document.getElementById('friend-recommendations');
                    if (recommendations.length === 0) {
                        container.innerHTML = '<p class="text-muted text-center p-3">No suggestions available at the moment.</p>';
                        return;
                    }

                    let html = '';
                    recommendations.forEach(user => {
                        html += `
                            <div class="d-flex align-items-center p-3 ${recommendations.indexOf(user) !== recommendations.length - 1 ? 'border-bottom' : ''}">
                                <img src="${user.profile_pic.startsWith('images/') ? '/static/' + user.profile_pic : '/uploaded_profile_pic/' + user.profile_pic.split('/').pop()}"
                                     class="rounded-circle mr-3"
                                     style="width: 45px; height: 45px; object-fit: cover;"
                                     alt="${user.username}'s profile picture">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">${user.first_name} ${user.last_name}</h6>
                                    <small class="text-muted">@${user.username}</small>
                                </div>
                                <a href="/profile/${user.username}" 
                                   class="btn btn-outline-primary btn-sm">View</a>
                            </div>`;
                    });
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading recommendations:', error);
                    document.getElementById('friend-recommendations').innerHTML = 
                        '<p class="text-muted text-center p-3">Error loading suggestions.</p>';
                });
        }

        // Load recommendations when page loads
        document.addEventListener('DOMContentLoaded', loadFriendRecommendations);

        // Listen for friend addition events
        document.addEventListener('friendAdded', loadFriendRecommendations);
    </script>
{% endblock %}